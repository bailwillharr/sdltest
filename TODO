REFACTOR THIS COMPLETE UNCOMPILABLE MESS OF SHARED_PTRS AND UNIQUE_PTRS!!!
DONE? I think?